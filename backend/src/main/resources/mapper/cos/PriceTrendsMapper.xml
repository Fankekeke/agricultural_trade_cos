<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cc.mrbird.febs.cos.dao.PriceTrendsMapper">

    <!-- 分页获取价格记录信息 -->
    <select id="queryPriceTrendsPage" resultType="java.util.LinkedHashMap">
        SELECT
        id,
        record_date,
        category,
        price
        FROM
        price_trends
        WHERE
        1 = 1
        <if test="queryParam.category != null and queryParam.category != ''">
            AND category LIKE CONCAT('%',#{queryParam.category},'%')
        </if>
        ORDER BY
        record_date DESC
    </select>

    <!-- 获取指定品类的历史价格数据（最近14天） -->
    <select id="getHistoryPriceData" resultType="java.util.LinkedHashMap">
        WITH RECURSIVE date_series AS (
        SELECT DATE_SUB(CURDATE(), INTERVAL 13 DAY) as date
        UNION ALL
        SELECT DATE_ADD(date, INTERVAL 1 DAY)
        FROM date_series
        WHERE date &lt; CURDATE()
        ),
        daily_avg_prices AS (
        SELECT
        DATE_FORMAT(record_date, '%Y-%m-%d') as date,
        AVG(price) as avg_price
        FROM price_trends
        WHERE category = #{category}
        GROUP BY DATE_FORMAT(record_date, '%Y-%m-%d')
        ),
        filled_prices AS (
        SELECT
        ds.date,
        (SELECT dap.avg_price
        FROM daily_avg_prices dap
        WHERE dap.date &lt;= ds.date
        ORDER BY dap.date DESC
        LIMIT 1
        ) as price
        FROM date_series ds
        )
        SELECT
        date,
        COALESCE(price,
        (SELECT AVG(price) FROM price_trends WHERE category = #{category} ORDER BY record_date DESC LIMIT 1)
        ) as price
        FROM filled_prices
        ORDER BY date ASC
    </select>
</mapper>
